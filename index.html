<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Rotaciones AVCR</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

<style>
/* ========== GENERAL & LAYOUT ========== */
:root {
    --primary-color: #5b037f;
    --secondary-color: #862a91;
    --background-gradient: linear-gradient(90deg, #027bc5, #83006e);
    --light-gray: #f8f9fa;
    --text-color: #333;
    --border-color: #ccc;
}

body {
    font-family: "Open Sans", sans-serif;
    margin: 0;
    padding: 0;
    background: var(--background-gradient);
    color: var(--text-color);
}

header {
    background: var(--primary-color);
    color: white;
    text-align: center;
    padding: 15px 0;
    font-size: 24px;
    font-weight: bold;
}

.page-wrapper {
    display: grid;
    grid-template-columns: 1fr;
    gap: 20px;
    width: 95%;
    max-width: 1600px;
    margin: 20px auto;
}

@media (min-width: 1024px) {
    .page-wrapper {
        grid-template-columns: 70fr 30fr;
    }
}

.main-content, .sidebar {
    background: white;
    padding: 20px;
    border-radius: 10px;
    box-shadow: 0 0 15px rgba(0,0,0,0.1);
}

h2 {
    color: var(--primary-color);
    border-bottom: 2px solid var(--secondary-color);
    padding-bottom: 5px;
    margin-top: 20px;
    margin-bottom: 15px;
}

/* ========== CONTROL PANEL ========== */
.control-panel {
    display: flex;
    flex-wrap: wrap;
    justify-content: space-between;
    align-items: center;
    gap: 15px;
    margin-bottom: 20px;
    padding: 15px;
    background-color: var(--light-gray);
    border-radius: 8px;
    border: 1px solid #ddd;
}
body.presentation-mode .control-panel { display: none; }

.control-group { display: flex; align-items: center; gap: 15px; flex-wrap: wrap; }
#context-selector {
    padding: 8px; font-size: 14px; background-color: var(--primary-color);
    color: white; border: none; border-radius: 4px; font-weight: bold;
}
button {
    background: var(--secondary-color); color: white; border: none; padding: 8px 15px;
    font-size: 14px; cursor: pointer; border-radius: 5px; transition: background 0.3s;
    display: inline-flex; align-items: center; gap: 8px;
}
button:hover { background: #005a9e; }
button i { font-size: 1.1em; }
button.presentation-btn { background: #6c757d; }
button.db-editor-btn { background: #008f39; }

/* ========== TABLES ========== */
table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 10px;
    margin-bottom: 20px;
}
th, td { border: 1px solid var(--border-color); padding: 10px; text-align: center; }
th { background-color: var(--secondary-color); color: white; }
#rotacion tbody tr:nth-child(even) { background-color: var(--light-gray); }
td[contenteditable="true"] { background: #f0f8ff; outline: none; }
body.presentation-mode td[contenteditable="true"] { background: transparent; }

/* Cell styles */
.alta { background-color:#FF9999; color:#000; font-weight:bold; }
.media { background-color:#FFF3B0; color:#000; font-weight:bold; }
.baja { background-color:#B5EAD7; color:#000; font-weight:bold; }
td.station-name { font-weight: 600; }
td.station-name[title] {
    cursor: help;
    text-decoration: underline;
    text-decoration-style: dotted;
}
.unassigned { background-color: #fff0f0 !important; }
.unassigned span { color: red; font-weight: bold; }

/* ========== SIDEBAR ELEMENTS ========== */
body.presentation-mode .sidebar .hide-in-presentation { display: none; }
textarea { width: 100%; box-sizing: border-box; height: 100px; font-size: 14px; padding: 8px; border: 1px solid var(--border-color); border-radius: 5px; resize: vertical; }
.helper { font-size: 12px; color: #555; margin-top: 5px; }

/* ========== LEGEND & FOOTER ========== */
.legend { margin-top: 20px; font-size: 13px; display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; }
.legend .item { display:flex; align-items:center; gap:8px; }
.legend .swatch { width:18px; height:18px; border-radius:4px; border:1px solid #999; }
.legend .swatch.alta { background:#FF9999; }
.legend .swatch.media { background:#FFF3B0; }
.legend .swatch.baja { background:#B5EAD7; }
.footer { text-align: center; margin-top: 20px; font-size: 14px; color: #777; padding: 10px; }

/* ========== MODAL ========== */
.modal-overlay { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); }
.modal-content { background-color: #fefefe; margin: 5% auto; padding: 25px; border: 1px solid #888; width: 80%; max-width: 800px; border-radius: 10px; }
.modal-content h2 { color: var(--primary-color); }
.editor-grid { display: grid; grid-template-columns: 1fr 2fr; gap: 20px; }
#person-list { list-style-type: none; padding: 0; margin: 0; height: 300px; overflow-y: auto; border: 1px solid var(--border-color); }
#person-list li { padding: 8px; cursor: pointer; border-bottom: 1px solid #eee; }
#person-list li:hover { background-color: #f0f0f0; }
#person-list li.selected { background-color: var(--secondary-color); color: white; font-weight: bold; }
.station-checkboxes { column-count: 2; }
.station-checkboxes label { display: block; margin-bottom: 5px; }
</style>
</head>
<body>

<header>Rotaciones AVCR</header>

<div class="control-panel">
    <div class="control-group">
        <label for="context-selector"><strong>Línea/Producto:</strong></label>
        <select id="context-selector">
            <option value="NC Trek NEO_1.4">NC Trek NEO - 1.4</option>
            <option value="NC Trek_1.5">NC Trek - 1.5</option>
        </select>
    </div>
    <div class="control-group">
        <button onclick="generarRotacion()"><i class="fa-solid fa-arrows-rotate"></i>Rotación</button>
        <button onclick="generarMedioDia()"><i class="fa-solid fa-clock"></i>10:00</button>
        <button onclick="descargarImagen()"><i class="fa-solid fa-camera"></i>Imagen</button>
        <button onclick="copiarLista()"><i class="fa-solid fa-copy"></i>Copiar</button>
    </div>
    <div class="control-group">
        <button onclick="openDbEditor()" class="db-editor-btn"><i class="fa-solid fa-database"></i>Editar Base de Datos</button>
        <button onclick="togglePresentationMode()" class="presentation-btn" title="Modo Presentación"><i class="fa-solid fa-eye"></i></button>
    </div>
</div>

<div class="page-wrapper">
    <div class="main-content">
        <div style="display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid var(--secondary-color); margin-bottom: 10px;">
            <h2 style="border-bottom: none; margin: 0;">Rotación Diaria</h2>
            <div id="contador-personal" style="font-weight: bold;"></div>
        </div>
        <table id="rotacion">
            <thead>
                <tr><th>Estación</th><th>TM´s</th></tr>
            </thead>
            <tbody></tbody>
        </table>
        <div class="legend">
            <div class="item"><span class="swatch alta"></span> <span><b>H</b> = High (Alta carga)</span></div>
            <div class="item"><span class="swatch media"></span> <span><b>M</b> = Medium (Media carga)</span></div>
            <div class="item"><span class="swatch baja"></span> <span><b>L</b> = Low (Baja carga)</span></div>
            <div class="item numbers">
                <span>1=Cuello</span> • <span>2=Hombros</span> • <span>3=Codos</span> • <span>4=Muñecas</span> • <span>5=Manos</span>
            </div>
        </div>
    </div>

    <div class="sidebar">
        <div id="semana-tracker" style="display: flex; gap: 8px; text-align: center; border: 1px solid #ddd; padding: 8px; border-radius: 4px; margin-bottom: 20px; justify-content: space-around;">
            <div><b>L</b><br><span id="pct-L" contenteditable="true"></span></div>
            <div><b>M</b><br><span id="pct-M" contenteditable="true"></span></div>
            <div><b>K</b><br><span id="pct-K" contenteditable="true"></span></div>
            <div><b>J</b><br><span id="pct-J" contenteditable="true"></span></div>
            <div><b>V</b><br><span id="pct-V" contenteditable="true"></span></div>
        </div>

        <h2 id="sobrantes-title">TM´s Sobrantes</h2>
        <table id="sobrantes">
            <thead><tr><th>Persona</th></tr></thead>
            <tbody></tbody>
        </table>

        <div class="hide-in-presentation">
            <h2 id="ausentes-title">TM´s Ausentes</h2>
            <textarea id="ausentesInput" placeholder="Un nombre por línea..."></textarea>
            <div class="helper">No importan mayúsculas/acentos.</div>
        </div>

        <h2 id="comentarios-title">Comentarios</h2>
        <div id="comentarios" contenteditable="true" style="width: 100%; box-sizing: border-box; min-height: 80px; border: 1px solid var(--border-color); padding: 8px; border-radius: 5px; margin-bottom: 20px;"></div>
    </div>
</div>

<div class="footer">© 2025 Abbott Vascular - Sistema de Rotaciones NEO Julian Nuñez (Optimizado)</div>

<script>
/* ========== BASE DE DATOS ========== */
let database = {};
const initialDatabase = {
    "NC Trek NEO": { "1.4": { personas: { "Ana":["Marcadores de IM","Fundas"], "Brayner":["Hipotubo","Notch","Leak Test","Empaque"], "Carlos":["Distal Laser","Hidro","Empaque"], "Celia":["IM Necking","Marcadores de IM","Notch","Hipotubo"], "Elizabeth":["IM Necking","Marcadores de IM","Laser de Marcadores"], "Elvia":["OM"], "Estefany":["Plasma","Hidro","Fold"], "Gian Marco":["Notch","Hipotubo","Sidearm"], "Jaqueline":["Sidearm","Coil"], "Jennifer":["Distal Laser","Notch","Hipotubo"], "Jeremy":["Press","Coil","Fundas"], "Johan":["OM","Proximal"], "Jose L.":["Hidro","Plasma","Laser de Marcadores"], "Jose P.":["OM","Plasma","Hidro","Fold"], "Juan":["Notch","Plasma","Hidro"], "Julian":["Fold","Press","Pouch","Empaque"], "Karina":["Laser de Marcadores"], "Kevin":["Marcadores de IM","Proximal","Fold"], "Kervin":["OM","Distal Prep","Distal Laser"], "Keylin":["IM Necking","Marcadores de IM","Laser de Marcadores"], "Leslie":["Leak Test","Plasma","Fold"], "Melania":["OM","Plasma","Hidro"], "Monserrat":["Corte de Balloon","Proximal","Distal Prep","Leak Test"], "Older":["Notch","Plasma","Hidro","Fundas"], "Rebeca":["Marcadores de IM","Distal Prep"], "Sebastian":["Corte de Balloon","Press","Coil","Pouch"], "Sharon":["IM Necking","Marcadores de IM","Laser de Marcadores"], "Stephanie":["Leak Test","Press","Fundas"], "Suchayle":["OM","Distal Laser","Notch","Hipotubo"], "Valeria":["IM Necking","Marcadores de IM","Hipotubo","Sidearm"] }, estaciones: { "IM Necking":2, "Marcadores de IM":2, "Laser de Marcadores":2, "OM":2, "Corte de Balloon":1, "Proximal":1, "Distal Prep":2, "Distal Laser":2, "Notch":3, "Hipotubo":2, "Sidearm":1, "Leak Test":1, "Plasma":1, "Hidro":1, "Fold":2, "Fundas":1, "Press":1, "Coil":1, "Pouch":1, "Empaque":1 }, ordenEstaciones: [ "IM Necking", "Marcadores de IM", "Laser de Marcadores", "OM", "Corte de Balloon", "Proximal", "Distal Prep", "Distal Laser", "Notch", "Hipotubo", "Sidearm", "Leak Test", "Plasma", "Hidro", "Fold", "Fundas", "Press", "Coil", "Pouch", "Empaque" ] } },
    "NC Trek": { "1.5": { personas: { "Maritza": ["Bayoneta", "IM Necking", "Marcadores", "Distal P", "Hipotubo"], "Kimberly": ["Bayoneta", "Sidearm"], "Ligia": ["Bayoneta", "IM Necking", "Marcadores", "Laser de M."], "Rosita": ["IM Necking", "Corte", "Distal P"], "Daniela": ["IM Necking", "Punta", "Fold"], "Jurgen": ["IM Necking"], "Noe": ["IM Necking"], "Yaine": ["Marcadores", "Laser de M.", "Pouch"], "Nicole": ["Marcadores", "Distal P", "Fold"], "Kevin": ["Marcadores", "Punta", "Sidearm"], "Ruben": ["Laser de M.", "Notch", "Fold"], "Susana": ["Laser de M.", "Hipotubo"], "Adrian": ["Laser de M.", "Plasma", "Hidro"], "Jeremy": ["OM Necking", "Midlap", "Pouch", "Empaque"], "Alejandra": ["OM Necking"], "Jose Ovidio": ["OM Necking"], "Yendry": ["OM Necking", "Notch", "Press"], "Kimberly C": ["Midlap", "Proximal", "Hipotubo"], "Miguel": ["Midlap", "Proximal", "Distal P", "Punta", "Plasma", "Hidro"], "Yency": ["Midlap", "Fold"], "Yahaira": ["Midlap", "Press", "Coil", "Pouch"], "Naomy": ["Corte", "Distal L.", "Fold"], "Iris": ["Corte", "Distal P", "Coil"], "Kendall": ["Proximal", "Distal L.", "Plasma", "Hidro", "Fold"], "Andres": ["Proximal", "Distal L.", "LKS"], "Maicol": ["Distal L.", "LKS", "Plasma", "Hidro"], "Fabiola": ["Distal L.", "Notch", "Coil"], "Fernanda": ["Distal L.", "Fundas"], "Sailyn": ["Punta", "Sidearm", "Plasma"], "Andrea": ["Notch", "Hipotubo", "LKS"], "Cinthya": ["Notch", "Press", "Fundas"], "Ana": ["Notch"], "Jose": ["Plasma", "Hidro", "Coil", "Empaque"], "Annie": ["Press", "Empaque", "Fundas"] }, estaciones: { "Notch": 3, "IM Necking": 2, "Marcadores": 2, "Laser de M.": 2, "OM Necking": 2, "Midlap": 2, "Distal Prep": 2, "Distal L.": 2, "Hipotubo": 2, "Distal P": 2, "Fold": 2, "Proximal": 1, "Bayoneta": 1, "Corte": 1, "Punta": 1, "Sidearm": 1, "LKS": 1, "Plasma": 1, "Hidro": 1, "Press": 1, "Coil": 1, "Pouch": 1, "Empaque": 1, "Fundas": 1 }, ordenEstaciones: [ "Bayoneta", "IM Necking", "Marcadores", "Laser de M.", "OM Necking", "Midlap", "Corte", "Proximal", "Distal P", "Distal L.", "Punta", "Notch", "Hipotubo", "Sidearm", "LKS", "Plasma", "Hidro", "Fold", "Press", "Coil", "Pouch", "Empaque", "Fundas" ] } }
};
function loadDatabase() { const savedDb = localStorage.getItem('rotationDatabase'); if (savedDb) { try { database = JSON.parse(savedDb); } catch (e) { console.error("Error al cargar la base de datos guardada, usando la inicial.", e); database = initialDatabase; } } else { database = initialDatabase; localStorage.setItem('rotationDatabase', JSON.stringify(database)); } }
const ergoMap = { "IM Necking": ["L1"], "Marcadores de IM": ["H5"], "Laser de Marcadores": ["M4"], "OM": ["L2"], "Corte de Balloon": ["H5"], "Proximal": ["L4"], "Distal Prep": ["L4","M4"], "Distal Laser": ["L3"], "Notch": ["L5"], "Hipotubo": ["M4"], "Sidearm": ["L2"], "Leak Test": ["L2"], "Plasma": ["H2"], "Hidro": ["H2"], "Fold": ["M1"], "Press": ["L2"], "Fundas": ["M1"], "Coil": ["M2"], "Pouch": ["L3"], "Empaque": ["M4"], "Bayoneta": ["M4"], "Marcadores": ["H5"], "Laser de M.": ["M4"], "OM Necking": ["L2"], "Midlap": ["L4"], "Corte": ["H5"], "Distal P": ["L4"], "Distal L.": ["L3"], "Punta": ["M5"], "LKS": ["L2"] };
const letraToClase = { H: "alta", M: "media", L: "baja" };

/* ========== VARIABLES DE ESTADO ACTIVO ========== */
let activePersonas = {}, activeEstaciones = {}, nameIndex = {}, activeOrdenEstaciones = [];
let ultimaRotacion = {}, ultimaRotacionPrev = null, historialErgonomico = {}, esVistaMedioDia = false;
let rotacionBaseParaMedioDia = {};

/* ========== NORMALIZACIÓN Y UTILIDADES ========== */
const NFD = /[\u0300-\u036f]/g;
function norm(s){ return (s||"").toString().normalize("NFD").replace(NFD,"").toLowerCase().replace(/\s+/g," ").trim(); }
function canonicalize(name){ const key=norm(name); return nameIndex[key]||null; }
function obtenerAusentes(){ const texto=document.getElementById("ausentesInput").value; return (texto?texto.split(/\r?\n/):[]).map(canonicalize).filter(Boolean); }

/* ========== GESTIÓN DE ESTADO ========== */
function getStorageKey(base) { const [familia, linea] = document.getElementById('context-selector').value.split('_'); return `${familia}-${linea}-${base}`; }
function guardarRotacion(rot, key){ localStorage.setItem(key, JSON.stringify(rot)); }
function cargarRotacion(key){ const txt=localStorage.getItem(key); if(txt){ try{ return JSON.parse(txt);}catch(e){return null;} } return null; }
function guardarHistorial(hist){ localStorage.setItem(getStorageKey('history'), JSON.stringify(hist)); }
function cargarHistorial(){ const txt=localStorage.getItem(getStorageKey('history')); if(txt){ try{ return JSON.parse(txt);}catch(e){return null;} } return null; }

/* ========== ALGORITMO DE ROTACIÓN ========== */
function esCargaAlta(est) { const tags = ergoMap[est] || []; return tags.some(tag => tag.startsWith('H')); }
function candidatosPara(est, ausentesSet, asignadosSet){ return Object.keys(activePersonas).filter(p => activePersonas[p].includes(est) && !ausentesSet.has(p) && !asignadosSet.has(p)); }
function rellenarEstacionesVacias(rotacion) { const ausentes = new Set(obtenerAusentes()); const usadas = new Set(Object.values(rotacion).flat().filter(Boolean)); let sobrantes = Object.keys(activePersonas).filter(p => !usadas.has(p) && !ausentes.has(p)); for (const est of activeOrdenEstaciones) { const capacidad = activeEstaciones[est] || 0; const asignados = rotacion[est] ? rotacion[est].slice() : []; while (asignados.length < capacidad) { const candIndex = sobrantes.findIndex(p => activePersonas[p].includes(est)); if (candIndex === -1) break; const p = sobrantes.splice(candIndex,1)[0]; asignados.push(p); } rotacion[est] = asignados; } return rotacion; }
function intentarConstruirRotacion(estacionesOrdenadas, ausentesSet) { const rot = {}; const asignados = new Set(); for (const est of Object.keys(activeEstaciones)) rot[est] = []; for (const est of estacionesOrdenadas) { const needed = activeEstaciones[est] || 0; let cand = candidatosPara(est, ausentesSet, asignados); if (esCargaAlta(est)) { cand = cand.filter(p => { const h = historialErgonomico[p] || []; return !(h.length >= 2 && esCargaAlta(h[0]) && esCargaAlta(h[1])); }); } cand.sort((a,b) => (activePersonas[a].length - activePersonas[b].length)); if (cand.length === 0) continue; const toTake = Math.min(needed, cand.length); const seleccion = cand.slice(0, toTake); rot[est] = seleccion.slice(); seleccion.forEach(p => asignados.add(p)); } return rot; }
function evaluarRotacion(rotacion) { const estacionesLlenas = Object.keys(rotacion).filter(e => (rotacion[e]||[]).length >= (activeEstaciones[e]||0)).length; const usadas = new Set(Object.values(rotacion).flat().filter(Boolean).map(p=>p.replace(/ \(T\)$/,''))); const sobrantes = Object.keys(activePersonas).filter(p => !usadas.has(p) && !new Set(obtenerAusentes()).has(p)).length; const assignedAll = Object.values(rotacion).flat().map(p=>p.replace(/ \(T\)$/,'')); const duplicates = assignedAll.length - new Set(assignedAll).size; return estacionesLlenas * 100 - sobrantes * 10 - duplicates * 50; }
function generarRotacionOptimizada(intentos = 60) { const ausentesSet = new Set(obtenerAusentes()); let mejor = null; let mejorScore = -Infinity; const baseOrden = [...activeOrdenEstaciones].slice(); baseOrden.sort((a,b) => { const cA = candidatosPara(a, ausentesSet, new Set()).length; const cB = candidatosPara(b, ausentesSet, new Set()).length; if (cA !== cB) return cA - cB; return (esCargaAlta(b)?1:0) - (esCargaAlta(a)?1:0); }); for (let i=0;i<intentos;i++) { const estacionesOrdenadas = baseOrden.slice(); if (i % 3 === 0) estacionesOrdenadas.reverse(); if (i % 5 === 0) estacionesOrdenadas.sort(() => Math.random() - 0.5); const rot = intentarConstruirRotacion(estacionesOrdenadas, ausentesSet); const rotRellenada = rellenarEstacionesVacias(JSON.parse(JSON.stringify(rot))); const score = evaluarRotacion(rotRellenada); if (score > mejorScore) { mejorScore = score; mejor = rotRellenada; } } if (!mejor) { const greedy = intentarConstruirRotacion(baseOrden, new Set()); mejor = rellenarEstacionesVacias(greedy); } return { rotacion: mejor }; }

/* ========== CONTROLADORES DE BOTONES ========== */
function actualizarHistorial(rotacionGenerada) { for (const est in rotacionGenerada) { for (const personaRaw of rotacionGenerada[est]) { const persona = personaRaw.replace(/ \(T\)$/,''); if (!historialErgonomico[persona]) historialErgonomico[persona] = []; historialErgonomico[persona].unshift(est); historialErgonomico[persona] = historialErgonomico[persona].slice(0, 2); } } }
function generarRotacion(){ esVistaMedioDia = false; const { rotacion: nuevaRotacion } = generarRotacionOptimizada(60); ultimaRotacion = nuevaRotacion; rotacionBaseParaMedioDia = JSON.parse(JSON.stringify(nuevaRotacion)); ultimaRotacionPrev = null; actualizarHistorial(ultimaRotacion); guardarRotacion(ultimaRotacion, getStorageKey("last")); guardarHistorial(historialErgonomico); actualizarTabla(); }
function generarMedioDia(){ if (Object.keys(rotacionBaseParaMedioDia).length === 0) { alert("Primero genera una rotación inicial con el botón 'Rotación'."); return; } esVistaMedioDia = true; ultimaRotacionPrev = JSON.parse(JSON.stringify(rotacionBaseParaMedioDia)); let mejorRotacion = null; let mejorPuntaje = -Infinity; const NUM_INTENTOS = 30; for (let i = 0; i < NUM_INTENTOS; i++) { const { rotacion: intento } = generarRotacionOptimizada(20); let personasRotadas = 0; for (const est in intento) { const list = (intento[est]||[]).map(x=>x.replace(/ \(T\)$/,'')); const prev = (ultimaRotacionPrev[est]||[]).map(x=>x.replace(/ \(T\)$/,'')); for (const p of list) if (!prev.includes(p)) personasRotadas++; } const score = personasRotadas; if (score > mejorPuntaje) { mejorPuntaje = score; mejorRotacion = intento; } } ultimaRotacion = mejorRotacion || generarRotacionOptimizada(10).rotacion; actualizarHistorial(ultimaRotacion); guardarRotacion(ultimaRotacion, getStorageKey("last")); guardarHistorial(historialErgonomico); actualizarTabla(); }

/* ========== INTERFAZ DE USUARIO (UI) ========== */
function togglePresentationMode() { document.body.classList.toggle('presentation-mode'); }
function tagsForStation(est){ const tags=ergoMap[est]||[]; return tags.map(t => ({letra:t[0], clase:letraToClase[t[0]]||"otro"})); }
function claseDominante(tags){ let b={s:0,c:"baja"}; for(const t of tags){const s=({H:3,M:2,L:1})[t.letra]||0; if(s>b.s) b={s,c:t.clase};} return b.c; }

// **INICIO DEL BLOQUE CORREGIDO: Funciones para generar el texto del tooltip**
function bodyPart(n){ const p = {1:"Cuello",2:"Hombros",3:"Codos",4:"Muñecas",5:"Manos"}; return p[n]||""; }
function loadName(l) { const p = {H:"Alta", M:"Media", L:"Baja"}; return p[l]||""; }
function getErgoTooltipText(station) {
    const tags = ergoMap[station] || [];
    if (tags.length === 0) return "";
    const descriptions = tags.map(tag => {
        const loadLetter = tag[0];
        const partNumber = parseInt(tag.slice(1), 10);
        return `${loadName(loadLetter)} (${bodyPart(partNumber)})`;
    });
    return `Carga Ergonómica: ${descriptions.join('; ')}`;
}
// **FIN DEL BLOQUE CORREGIDO**

function actualizarContadores() { const totalPersonal = Object.keys(activePersonas).length; const numAusentes = obtenerAusentes().length; const presentes = totalPersonal - numAusentes; const contadorDiv = document.getElementById('contador-personal'); let ausentesHtml = numAusentes > 0 ? ` <span style="color:red;">(-${numAusentes} Ausentes)</span>` : ''; let porcentajeHtml = ''; if (esVistaMedioDia && presentes > 0) { let numNoRotando = 0; if (ultimaRotacion && ultimaRotacionPrev) { for (const est in ultimaRotacion) { if (ultimaRotacion[est] && ultimaRotacionPrev[est]) { for (const p of ultimaRotacion[est]) { if (ultimaRotacionPrev[est].includes(p.replace(/ \(T\)$/,''))) numNoRotando++; } } } } const numSobrantes = document.querySelectorAll('#sobrantes tbody tr').length; const totalNoRotando = numNoRotando + numSobrantes; const numRotando = presentes - totalNoRotando; const porcentaje = presentes > 0 ? (numRotando / presentes) * 100 : 0; const color = porcentaje < 80 ? 'red' : 'green'; porcentajeHtml = ` <span style="margin-left: 15px; color: ${color};">(${porcentaje.toFixed(0)}%)</span>`; const diaSemana = new Date().getDay(); if(diaSemana >= 1 && diaSemana <= 5) { const dias = ['L', 'M', 'K', 'J', 'V']; const idDia = dias[diaSemana - 1]; const pctSpan = document.getElementById(`pct-${idDia}`); if(pctSpan) { pctSpan.textContent = `${porcentaje.toFixed(0)}%`; actualizarEstilosSemana(); guardarDatosSemana(); } } } if (contadorDiv) contadorDiv.innerHTML = `${presentes}/${totalPersonal} TM Presentes` + ausentesHtml + porcentajeHtml; }
const getDuplicateAssignments = () => { const assignments = new Map(); const duplicates = new Set(); for (const station in ultimaRotacion) { for (const person of ultimaRotacion[station]) { const p = person.replace(/ \(T\)$/,''); if (assignments.has(p)) { duplicates.add(p); } else { assignments.set(p, station); } } } return duplicates; };
function actualizarCeldaEditada(event) { const td = event.target; const est = td.dataset.station; const nombres = td.textContent.split('-').map(s => s.trim()).filter(Boolean); const personasFinal = []; for (const nombre of nombres) { const personaCanonica = canonicalize(nombre); let esEntrenamiento = false; if (personaCanonica && !activePersonas[personaCanonica].includes(est)) { esEntrenamiento = true; } if (personaCanonica) { personasFinal.push(esEntrenamiento ? `${personaCanonica} (T)` : personaCanonica); } else { personasFinal.push(nombre); } } if (activeEstaciones[est]) ultimaRotacion[est] = personasFinal.filter(p => canonicalize(p.replace(/ \(T\)$/,''))); if (!esVistaMedioDia) { rotacionBaseParaMedioDia = JSON.parse(JSON.stringify(ultimaRotacion)); } const capacity = activeEstaciones[est] || 0; const duplicates = getDuplicateAssignments(); const personasHtml = nombres.map((nombre, index) => { const personaCanonica = canonicalize(nombre); if (!personaCanonica) return `<span style="color:red; font-weight:bold;">${nombre}</span>`; const pFinal = personasFinal.find(p => canonicalize(p.replace(/ \(T\)$/,'')) === personaCanonica); if (esVistaMedioDia && ultimaRotacionPrev && ultimaRotacionPrev[est]?.includes(personaCanonica)) return `<span style="color:red; font-weight:bold;">${pFinal}</span>`; if (duplicates.has(personaCanonica)) return `<span style="color:darkred; font-weight:bold;">${pFinal}</span>`; if (index >= capacity) return `<span style="color:orange; font-weight:bold;">${pFinal}</span>`; return pFinal; }).join(' - '); td.innerHTML = (nombres.length === 0) ? `<span>(sin asignar)</span>` : personasHtml; if(nombres.length === 0) { td.parentElement.classList.add('unassigned'); } else { td.parentElement.classList.remove('unassigned'); } guardarRotacion(ultimaRotacion, getStorageKey("last")); actualizarSobrantes(); actualizarContadores(); }

function actualizarTabla(){
    const tbody=document.querySelector("#rotacion tbody");
    tbody.innerHTML="";
    if (!activeOrdenEstaciones) return;
    const duplicates = getDuplicateAssignments();
    for(const est of activeOrdenEstaciones) {
        const pers = ultimaRotacion[est] || [];
        const tr=document.createElement("tr");
        const tags = tagsForStation(est);
        const tdEst=document.createElement("td");
        tdEst.textContent = est;
        tdEst.className = "station-name";
        
        if(tags.length){
            tdEst.classList.add(claseDominante(tags));
            tdEst.title = getErgoTooltipText(est); 
        }

        const tdPers=document.createElement("td");
        tdPers.contentEditable="true";
        tdPers.dataset.station = est;
        let personasHtml;
        if (pers.length === 0) {
            personasHtml = `<span>(sin asignar)</span>`;
            tr.classList.add("unassigned");
        } else {
            const capacity = activeEstaciones[est] || 0;
            personasHtml = pers.map((p, index) => {
                const pCanon = p.replace(/ \(T\)$/,'');
                if (esVistaMedioDia && ultimaRotacionPrev && ultimaRotacionPrev[est]?.includes(pCanon)) return `<span style="color:red; font-weight:bold;">${p}</span>`;
                if (duplicates.has(pCanon)) return `<span style="color:darkred; font-weight:bold;">${p}</span>`;
                if (index >= capacity) return `<span style="color:orange; font-weight:bold;">${p}</span>`;
                return p;
            }).join(' - ');
        }
        tdPers.innerHTML = personasHtml;
        tdPers.addEventListener("blur", actualizarCeldaEditada);
        tr.appendChild(tdEst);
        tr.appendChild(tdPers);
        tbody.appendChild(tr);
    }
    actualizarSobrantes();
    actualizarContadores();
}

function actualizarSobrantes(){ const usadas = new Set(); Object.values(ultimaRotacion).flat().forEach(p => { const canon = canonicalize(p.replace(/ \(T\)$/, '')); if (canon) usadas.add(canon); }); const ausentes=new Set(obtenerAusentes()); const sobrantes=Object.keys(activePersonas).filter(p=>!usadas.has(p)&&!ausentes.has(p)); const tbodyS=document.querySelector("#sobrantes tbody"); tbodyS.innerHTML=""; sobrantes.forEach(p=>{ const tr=document.createElement("tr"); tr.innerHTML=`<td>${p}</td>`; tbodyS.appendChild(tr); }); }
async function descargarImagen() { document.body.classList.add('presentation-mode'); await new Promise(resolve => setTimeout(resolve, 100)); const mainContainer = document.querySelector('.page-wrapper'); html2canvas(mainContainer, { scale: 2 }).then(canvas => { const imgUrl = canvas.toDataURL("image/png"); const printWindow = window.open('', '_blank'); printWindow.document.write(`<html<head><title>Rotación Generada</title></head><body style="margin:0;"><img src="${imgUrl}" style="width:100%;"></body></html>`); printWindow.document.close(); printWindow.focus(); document.body.classList.remove('presentation-mode'); }); }
async function copiarLista(){ let t=""; for(const r of document.querySelectorAll("#rotacion tbody tr")){ t+=`${r.cells[0].textContent}: ${r.cells[1].textContent}\n`; } try{await navigator.clipboard.writeText(t);alert("Rotación copiada.");} catch(e){const ta=document.createElement("textarea");ta.value=t;document.body.appendChild(ta);ta.select();document.execCommand("copy");document.body.removeChild(ta);alert("Copiada (alternativo).");} }
const dias = ['L', 'M', 'K', 'J', 'V']; function actualizarEstilosSemana() { dias.forEach(dia => { const span = document.getElementById(`pct-${dia}`); if(span) { const valor = parseInt(span.textContent.replace('%', ''), 10); if (!isNaN(valor)) { span.style.color = valor < 80 ? 'red' : 'green'; } else { span.style.color = ''; } } }); } function guardarDatosSemana() { const datos = {}; dias.forEach(dia => { const span = document.getElementById(`pct-${dia}`); if (span) datos[dia] = span.textContent; }); localStorage.setItem(getStorageKey('semanaPct'), JSON.stringify(datos)); } function cargarDatosSemana() { const datosGuardados = localStorage.getItem(getStorageKey('semanaPct')); if (datosGuardados) { const datos = JSON.parse(datosGuardados); dias.forEach(dia => { const span = document.getElementById(`pct-${dia}`); if (span && datos[dia]) span.textContent = datos[dia]; else if (span) span.textContent = '0%'; }); } else { dias.forEach(dia => { const span = document.getElementById(`pct-${dia}`); if (span) span.textContent = '0%'; }); } actualizarEstilosSemana(); }
function switchContext() { const [familia, linea] = document.getElementById('context-selector').value.split('_'); const contextData = database[familia]?.[linea]; if (!contextData) { alert("La combinación seleccionada no es válida o no tiene datos configurados."); return; } activePersonas = contextData.personas; activeEstaciones = contextData.estaciones; activeOrdenEstaciones = contextData.ordenEstaciones || Object.keys(activeEstaciones); nameIndex = Object.keys(activePersonas).reduce((acc, p) => { acc[norm(p)] = p; return acc; }, {}); esVistaMedioDia = false; ultimaRotacion = cargarRotacion(getStorageKey("last")) || {}; rotacionBaseParaMedioDia = JSON.parse(JSON.stringify(ultimaRotacion)); ultimaRotacionPrev = null; historialErgonomico = cargarHistorial() || {}; document.getElementById('ausentesInput').value = ''; document.getElementById('comentarios').innerHTML = ''; if (Object.keys(ultimaRotacion).length === 0) { for(const est of activeOrdenEstaciones) ultimaRotacion[est] = []; } cargarDatosSemana(); actualizarTabla(); }

/* ========== LÓGICA DEL EDITOR DE BASE DE DATOS ========== */
let selectedPersonForEditing = null;
function getCurrentContext() { const [familia, linea] = document.getElementById('context-selector').value.split('_'); return { familia, linea, data: database[familia]?.[linea] }; }
function openDbEditor() { document.getElementById('db-editor-modal').style.display = 'block'; const { familia, linea, data } = getCurrentContext(); if (!data) { alert("Contexto no válido."); return; } document.getElementById('editor-context-title').textContent = `${familia} - ${linea}`; const personList = document.getElementById('person-list'); personList.innerHTML = ''; const personNames = Object.keys(data.personas).sort(); personNames.forEach(name => { const li = document.createElement('li'); li.textContent = name; li.onclick = () => selectPersonForEditing(name); personList.appendChild(li); }); if (personNames.length > 0) { selectPersonForEditing(personNames[0]); } else { document.getElementById('person-name-input').value = ''; document.getElementById('station-checkboxes').innerHTML = ''; } }
function closeDbEditor() { document.getElementById('db-editor-modal').style.display = 'none'; }
function selectPersonForEditing(name) { selectedPersonForEditing = name; document.querySelectorAll('#person-list li').forEach(li => { li.classList.toggle('selected', li.textContent === name); }); const { data } = getCurrentContext(); const personSkills = data.personas[name] || []; document.getElementById('person-name-input').value = name; const stationCheckboxes = document.getElementById('station-checkboxes'); stationCheckboxes.innerHTML = ''; const allStations = Object.keys(data.estaciones).sort(); allStations.forEach(station => { const isChecked = personSkills.includes(station); const label = document.createElement('label'); label.innerHTML = `<input type="checkbox" value="${station}" ${isChecked ? 'checked' : ''}> ${station}`; stationCheckboxes.appendChild(label); }); }
function addNewPerson() { const newName = prompt("Introduce el nombre de la nueva persona:"); if (!newName || newName.trim() === "") return; const { familia, linea, data } = getCurrentContext(); if (data.personas[newName]) { alert("Esta persona ya existe."); return; } data.personas[newName] = []; openDbEditor(); selectPersonForEditing(newName); }
function deleteSelectedPerson() { if (!selectedPersonForEditing) { alert("Por favor, selecciona una persona para eliminar."); return; } if (confirm(`¿Estás seguro de que quieres eliminar a ${selectedPersonForEditing}?`)) { const { familia, linea, data } = getCurrentContext(); delete data.personas[selectedPersonForEditing]; selectedPersonForEditing = null; openDbEditor(); } }
function saveDbChanges() { const { familia, linea, data } = getCurrentContext(); const currentName = selectedPersonForEditing; const newName = document.getElementById('person-name-input').value.trim(); if (!newName) { alert("El nombre no puede estar vacío."); return; } const newSkills = []; document.querySelectorAll('#station-checkboxes input:checked').forEach(checkbox => { newSkills.push(checkbox.value); }); if (currentName !== newName) { if (data.personas[newName]) { alert("El nuevo nombre ya existe. Por favor, elige otro."); return; } delete data.personas[currentName]; data.personas[newName] = newSkills; } else { data.personas[currentName] = newSkills; } localStorage.setItem('rotationDatabase', JSON.stringify(database)); closeDbEditor(); alert("¡Base de datos actualizada! El sistema se recargará con los nuevos datos."); switchContext(); }

document.addEventListener("DOMContentLoaded",()=>{ loadDatabase(); document.getElementById('context-selector').addEventListener('change', switchContext); document.getElementById("ausentesInput").addEventListener("input", () => { actualizarSobrantes(); actualizarContadores(); }); dias.forEach(dia => { const span = document.getElementById(`pct-${dia}`); if(span) span.addEventListener('blur', () => { guardarDatosSemana(); actualizarEstilosSemana(); }); }); switchContext(); });
</script>

<div id="db-editor-modal" class="modal-overlay">
    <div class="modal-content">
        <h2>Editor de Base de Datos - <span id="editor-context-title"></span></h2>
        <div class="editor-grid">
            <div>
                <h3>Personal</h3>
                <ul id="person-list"></ul>
                <button onclick="addNewPerson()">Añadir Persona</button>
                <button onclick="deleteSelectedPerson()" style="background-color: #dc3545;">Eliminar</button>
            </div>
            <div>
                <h3>Detalles de la Persona</h3>
                <label for="person-name-input"><strong>Nombre:</strong></label>
                <input type="text" id="person-name-input" style="width: 95%; padding: 8px; margin-bottom: 15px; font-size: 1em;">
                <h4>Estaciones Asignadas</h4>
                <div id="station-checkboxes" class="station-checkboxes"></div>
            </div>
        </div>
        <hr>
        <button onclick="saveDbChanges()" class="db-editor-btn">Guardar Cambios y Recargar</button>
        <button onclick="closeDbEditor()" style="background-color: #6c757d;">Cancelar</button>
    </div>
</div>

</body>
</html>