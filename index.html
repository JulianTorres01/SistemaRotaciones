<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Rotaciones AVCR</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

<style>
/* ========== GENERAL & LAYOUT ========== */
:root {
    --primary-color: #5b037f;
    --secondary-color: #862a91;
    --background-gradient: linear-gradient(90deg, #027bc5, #83006e);
    --light-gray: #f8f9fa;
    --text-color: #333;
    --border-color: #ccc;

    --yo-mejoro: #FFF59D; /* amarillo */
    --yo-reconozco: #FFCDD2; /* rojo claro */
    --yo-anticipo: #C8E6C9; /* verde claro */
    --yo-cumplo: #E1BEE7; /* morado claro */
    --yo-respeto: #B3E5FC; /* celeste claro */

    --good: #1a7f2f;
    --bad: #c92a2a;
}

body {
    font-family: "Open Sans", sans-serif;
    margin: 0;
    padding: 0;
    background: var(--background-gradient);
    color: var(--text-color);
}

header {
    background: var(--primary-color);
    color: white;
    text-align: center;
    padding: 15px 0;
    font-size: 24px;
    font-weight: bold;
}

.page-wrapper {
    display: grid;
    grid-template-columns: 1fr;
    gap: 20px;
    width: 95%;
    max-width: 1600px;
    margin: 20px auto;
}

@media (min-width: 1024px) {
    .page-wrapper {
        grid-template-columns: 70fr 30fr;
    }
}

.main-content, .sidebar {
    background: white;
    padding: 20px;
    border-radius: 10px;
    box-shadow: 0 0 15px rgba(0,0,0,0.1);
}

h2 {
    color: var(--primary-color);
    border-bottom: 2px solid var(--secondary-color);
    padding-bottom: 5px;
    margin-top: 20px;
    margin-bottom: 15px;
}

/* ========== CONTROL PANEL ========== */
.control-panel {
    display: flex;
    flex-wrap: wrap;
    justify-content: space-between;
    align-items: center;
    gap: 15px;
    margin-bottom: 20px;
    padding: 15px;
    background-color: var(--light-gray);
    border-radius: 8px;
    border: 1px solid #ddd;
}
body.presentation-mode .control-panel { display: none; }

.control-group { display: flex; align-items: center; gap: 15px; flex-wrap: wrap; }
#context-selector {
    padding: 8px; font-size: 14px; background-color: var(--primary-color);
    color: white; border: none; border-radius: 4px; font-weight: bold;
}
button {
    background: var(--secondary-color); color: white; border: none; padding: 8px 15px;
    font-size: 14px; cursor: pointer; border-radius: 5px; transition: background 0.3s;
    display: inline-flex; align-items: center; gap: 8px;
}
button:hover { background: #005a9e; }
button i { font-size: 1.1em; }
button.presentation-btn { background: #6c757d; }
button.db-editor-btn { background: #008f39; }

/* ========== TABLES ========== */
table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 10px;
    margin-bottom: 20px;
}
th, td { border: 1px solid var(--border-color); padding: 10px; text-align: center; }
th { background-color: var(--secondary-color); color: white; }
#rotacion tbody tr:nth-child(even) { background-color: var(--light-gray); }
td[contenteditable="true"] { background: #f0f8ff; outline: none; }
body.presentation-mode td[contenteditable="true"] { background: transparent; }

/* Cell styles */
.alta { background-color:#FF9999; color:#000; font-weight:bold; }
.media { background-color:#FFF3B0; color:#000; font-weight:bold; }
.baja { background-color:#B5EAD7; color:#000; font-weight:bold; }
td.station-name { font-weight: 600; }
td.station-name[title] {
    cursor: help;
    text-decoration: underline;
    text-decoration-style: dotted;
}
.unassigned { background-color: #fff0f0 !important; }
.unassigned span { color: red; font-weight: bold; }

/* ========== SIDEBAR ELEMENTS ========== */
body.presentation-mode .sidebar .hide-in-presentation { display: none; }
textarea { width: 100%; box-sizing: border-box; height: 100px; font-size: 14px; padding: 8px; border: 1px solid var(--border-color); border-radius: 5px; resize: vertical; }
.helper { font-size: 12px; color: #555; margin-top: 5px; }

/* ========== YO... BOXES ========== */
#yo-seccion { display: grid; grid-template-columns: 1fr; gap: 10px; margin-top: 6px; }
.yo-box { padding: 10px; border-radius: 8px; min-height: 48px; display:flex; align-items:center; gap:10px; }
.yo-box .label { font-weight:700; width:150px; }
.yo-box .content { flex:1; min-height:28px; outline:none; }
.yo-mejoro { background: var(--yo-mejoro); }
.yo-reconozco { background: var(--yo-reconozco); }
.yo-anticipo { background: var(--yo-anticipo); }
.yo-cumplo { background: var(--yo-cumplo); }
.yo-respeto { background: var(--yo-respeto); }

/* ========== LEGEND & FOOTER ========== */
.legend { margin-top: 20px; font-size: 13px; display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; }
.legend .item { display:flex; align-items:center; gap:8px; }
.legend .swatch { width:18px; height:18px; border-radius:4px; border:1px solid #999; }
.legend .swatch.alta { background:#FF9999; }
.legend .swatch.media { background:#FFF3B0; }
.legend .swatch.baja { background:#B5EAD7; }
.footer { text-align: center; margin-top: 20px; font-size: 14px; color: #777; padding: 10px; }

/* ========== MODAL ========== */
.modal-overlay { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); }
.modal-content { background-color: #fefefe; margin: 5% auto; padding: 25px; border: 1px solid #888; width: 80%; max-width: 900px; border-radius: 10px; }
.modal-content img { width:100%; height:auto; display:block; border-radius:6px; }
.small-muted { font-size:12px; color:#666; margin-top:8px; }

/* Opcional: estilos sencillos para la lista del editor */
.editor-grid { display:grid; grid-template-columns: 280px 1fr; gap:18px; }
#person-list { list-style:none; padding:0; margin:0; max-height:350px; overflow:auto; border:1px solid #ddd; border-radius:6px; }
#person-list li { padding:8px 10px; cursor:pointer; border-bottom:1px solid #eee; }
#person-list li.selected { background:#f0f8ff; font-weight:700; }
.station-checkboxes label { display:block; margin-bottom:6px; }
</style>
</head>
<body>

<header>Rotaciones AVCR</header>

<div class="control-panel">
    <div class="control-group">
        <label for="context-selector"><strong>Línea/Producto:</strong></label>
        <select id="context-selector">
            <option value="NC Trek NEO_1.4">NC Trek NEO - 1.4</option>
            <option value="NC Trek_1.5">NC Trek - 1.5</option>
        </select>
    </div>
    <div class="control-group">
        <button onclick="generarRotacion()"><i class="fa-solid fa-arrows-rotate"></i>Rotación</button>
        <button onclick="volverARotacion()"><i class="fa-solid fa-undo"></i>Volver a Rotación</button>
        <button onclick="generarMedioDia()"><i class="fa-solid fa-clock"></i>10:00</button>
        <button onclick="descargarImagen()"><i class="fa-solid fa-camera"></i>Imagen</button>
        <button onclick="generarReporteSemanal()"><i class="fa-solid fa-chart-line"></i>Reporte Semanal</button>
        <button onclick="copiarLista()"><i class="fa-solid fa-copy"></i>Copiar</button>
    </div>
    <div class="control-group"> 
         <button onclick="openDbEditor()" class="db-editor-btn"><i class="fa-solid fa-database"></i>Editar Base de Datos</button>
         <button onclick="togglePresentationMode()" class="presentation-btn"><i class="fa-solid fa-eye"></i></button>
    </div>
</div>

<div class="page-wrapper">
    <div class="main-content">
        <div style="display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid var(--secondary-color); margin-bottom: 10px;">
            <h2 style="border-bottom: none; margin: 0;">Rotación Diaria</h2>
            <div id="contador-personal" style="font-weight: bold;"></div>
        </div>
        <table id="rotacion">
            <thead>
                <tr><th>Estación</th><th>TM´s</th></tr>
            </thead>
            <tbody></tbody>
        </table>
        <div class="legend">
            <div class="item"><span class="swatch alta"></span> <span><b>H</b> = High (Alta carga)</span></div>
            <div class="item"><span class="swatch media"></span> <span><b>M</b> = Medium (Media carga)</span></div>
            <div class="item"><span class="swatch baja"></span> <span><b>L</b> = Low (Baja carga)</span></div>
        </div>
    </div>

    <div class="sidebar">
        <div id="semana-tracker" style="display: flex; gap: 8px; text-align: center; border: 1px solid #ddd; padding: 8px; border-radius: 4px; margin-bottom: 20px; justify-content: space-around;">
            <div><b>L</b><br><span id="pct-L" contenteditable="true"></span></div>
            <div><b>M</b><br><span id="pct-M" contenteditable="true"></span></div>
            <div><b>K</b><br><span id="pct-K" contenteditable="true"></span></div>
            <div><b>J</b><br><span id="pct-J" contenteditable="true"></span></div>
            <div><b>V</b><br><span id="pct-V" contenteditable="true"></span></div>
        </div>

        <h2 id="sobrantes-title">TM´s Sobrantes</h2>
        <table id="sobrantes">
            <thead><tr><th>Persona</th></tr></thead>
            <tbody></tbody>
        </table>

        <div class="hide-in-presentation">
            <h2 id="ausentes-title">TM´s Ausentes</h2>
            <textarea id="ausentesInput" placeholder="Un nombre por línea..."></textarea>
            <div class="helper">No importan mayúsculas/acentos.</div>
        </div>

        <h2 id="comentarios-title">Comentarios</h2>
        <div id="comentarios" contenteditable="true" style="width: 100%; box-sizing: border-box; min-height: 80px; border: 1px solid var(--border-color); padding: 8px; border-radius: 5px; margin-bottom: 10px;"></div>
        
        <div id="yo-seccion" aria-label="Yo seccion">
            <div class="yo-box yo-mejoro"><div class="label">Yo Mejoro</div><div id="yo-mejoro" class="content" contenteditable="true"></div></div>
            <div class="yo-box yo-reconozco"><div class="label">Yo Reconozco</div><div id="yo-reconozco" class="content" contenteditable="true"></div></div>
            <div class="yo-box yo-anticipo"><div class="label">Yo Anticipo</div><div id="yo-anticipo" class="content" contenteditable="true"></div></div>
            <div class="yo-box yo-cumplo"><div class="label">Yo Cumplo</div><div id="yo-cumplo" class="content" contenteditable="true"></div></div>
            <div class="yo-box yo-respeto"><div class="label">Yo Respeto</div><div id="yo-respeto" class="content" contenteditable="true"></div></div>
        </div>
    </div>
</div>

<div class="footer">© 2025 Abbott Vascular - Sistema de Rotaciones NEO Julian Nuñez (Optimizado)</div>

<div id="report-modal" class="modal-overlay" onclick="closeReportModal(event)">
  <div class="modal-content" id="report-modal-content">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
      <h3 style="margin:0; color:var(--primary-color);">Vista Previa - Reporte Semanal</h3>
      <div>
        <button onclick="downloadCurrentReport()" style="background:#008f39;"><i class="fa-solid fa-download"></i> Descargar</button>
        <button onclick="closeReportModal(null)" style="background:#6c757d;">Cerrar</button>
      </div>
    </div>
    <div id="report-modal-image-container" style="background:#fff; padding:8px; border:1px solid #eee; border-radius:6px;"></div>
    <div class="small-muted">La imagen muestra los porcentajes, conteos y notas 'Yo...'.</div>
  </div>
</div>

<script>
/* ========== BASE DE DATOS ========== */
let database = {};
const initialDatabase = { "NC Trek NEO": { "1.4": { personas: { "Ana":["Marcadores de IM","Fundas"], "Brayner":["Hipotubo","Notch","Leak Test","Empaque"], "Carlos":["Distal Laser","Hidro","Empaque"], "Celia":["IM Necking","Marcadores de IM","Notch","Hipotubo"], "Elizabeth":["IM Necking","Marcadores de IM","Laser de Marcadores"], "Elvia":["OM"], "Estefany":["Plasma","Hidro","Fold"], "Gian Marco":["Notch","Hipotubo","Sidearm"], "Jaqueline":["Sidearm","Coil"], "Jennifer":["Distal Laser","Notch","Hipotubo"], "Jeremy":["Press","Coil","Fundas"], "Johan":["OM","Proximal"], "Jose L.":["Hidro","Plasma","Laser de Marcadores"], "Jose P.":["OM","Plasma","Hidro","Fold"], "Juan":["Notch","Plasma","Hidro"], "Julian":["Fold","Press","Pouch","Empaque"], "Karina":["Laser de Marcadores"], "Kevin":["Marcadores de IM","Proximal","Fold"], "Kervin":["OM","Distal Prep","Distal Laser"], "Keylin":["IM Necking","Marcadores de IM","Laser de Marcadores"], "Leslie":["Leak Test","Plasma","Fold"], "Melania":["OM","Plasma","Hidro"], "Monserrat":["Corte de Balloon","Proximal","Distal Prep","Leak Test"], "Older":["Notch","Plasma","Hidro","Fundas"], "Rebeca":["Marcadores de IM","Distal Prep"], "Sebastian":["Corte de Balloon","Press","Coil","Pouch"], "Sharon":["IM Necking","Marcadores de IM","Laser de Marcadores"], "Stephanie":["Leak Test","Press","Fundas"], "Suchayle":["OM","Distal Laser","Notch","Hipotubo"], "Valeria":["IM Necking","Marcadores de IM","Hipotubo","Sidearm"] }, estaciones: { "IM Necking":2, "Marcadores de IM":2, "Laser de Marcadores":2, "OM":2, "Corte de Balloon":1, "Proximal":1, "Distal Prep":2, "Distal Laser":2, "Notch":3, "Hipotubo":2, "Sidearm":1, "Leak Test":1, "Plasma":1, "Hidro":1, "Fold":2, "Fundas":1, "Press":1, "Coil":1, "Pouch":1, "Empaque":1 }, ordenEstaciones: [ "IM Necking", "Marcadores de IM", "Laser de Marcadores", "OM", "Corte de Balloon", "Proximal", "Distal Prep", "Distal Laser", "Notch", "Hipotubo", "Sidearm", "Leak Test", "Plasma", "Hidro", "Fold", "Fundas", "Press", "Coil", "Pouch", "Empaque" ] } }, "NC Trek": { "1.5": { personas: { "Maritza": ["Bayoneta", "IM Necking", "Marcadores", "Distal P", "Hipotubo"], "Kimberly": ["Bayoneta", "Sidearm"], "Ligia": ["Bayoneta", "IM Necking", "Marcadores", "Laser de M."], "Rosita": ["IM Necking", "Corte", "Distal P"], "Daniela": ["IM Necking", "Punta", "Fold"], "Jurgen": ["IM Necking"], "Noe": ["IM Necking"], "Yaine": ["Marcadores", "Laser de M.", "Pouch"], "Nicole": ["Marcadores", "Distal P", "Fold"], "Kevin": ["Marcadores", "Punta", "Sidearm"], "Ruben": ["Laser de M.", "Notch", "Fold"], "Susana": ["Laser de M.", "Hipotubo"], "Adrian": ["Laser de M.", "Plasma", "Hidro"], "Jeremy": ["OM Necking", "Midlap", "Pouch", "Empaque"], "Alejandra": ["OM Necking"], "Jose Ovidio": ["OM Necking"], "Yendry": ["OM Necking", "Notch", "Press"], "Kimberly C": ["Midlap", "Proximal", "Hipotubo"], "Miguel": ["Midlap", "Proximal", "Distal P", "Punta", "Plasma", "Hidro"], "Yency": ["Midlap", "Fold"], "Yahaira": ["Midlap", "Press", "Coil", "Pouch"], "Naomy": ["Corte", "Distal L.", "Fold"], "Iris": ["Corte", "Distal P", "Coil"], "Kendall": ["Proximal", "Distal L.", "Plasma", "Hidro", "Fold"], "Andres": ["Proximal", "Distal L.", "LKS"], "Maicol": ["Distal L.", "LKS", "Plasma", "Hidro"], "Fabiola": ["Distal L.", "Notch", "Coil"], "Fernanda": ["Distal L.", "Fundas"], "Sailyn": ["Punta", "Sidearm", "Plasma"], "Andrea": ["Notch", "Hipotubo", "LKS"], "Cinthya": ["Notch", "Press", "Fundas"], "Ana": ["Notch"], "Jose": ["Plasma", "Hidro", "Coil", "Empaque"], "Annie": ["Press", "Empaque", "Fundas"] }, estaciones: { "Notch": 3, "IM Necking": 2, "Marcadores": 2, "Laser de M.": 2, "OM Necking": 2, "Midlap": 2, "Distal Prep": 2, "Distal L.": 2, "Hipotubo": 2, "Distal P": 2, "Fold": 2, "Proximal": 1, "Bayoneta": 1, "Corte": 1, "Punta": 1, "Sidearm": 1, "LKS": 1, "Plasma": 1, "Hidro": 1, "Press": 1, "Coil": 1, "Pouch": 1, "Empaque": 1, "Fundas": 1 }, ordenEstaciones: [ "Bayoneta", "IM Necking", "Marcadores", "Laser de M.", "OM Necking", "Midlap", "Corte", "Proximal", "Distal P", "Distal L.", "Punta", "Notch", "Hipotubo", "Sidearm", "LKS", "Plasma", "Hidro", "Fold", "Press", "Coil", "Pouch", "Empaque", "Fundas" ] } } };
function loadDatabase() { const savedDb = localStorage.getItem('rotationDatabase'); if (savedDb) { try { database = JSON.parse(savedDb); } catch (e) { console.error("Error al cargar la base de datos guardada, usando la inicial.", e); database = initialDatabase; } } else { database = initialDatabase; localStorage.setItem('rotationDatabase', JSON.stringify(database)); } }
const ergoMap = { "IM Necking": ["L1"], "Marcadores de IM": ["H5"], "Laser de Marcadores": ["M4"], "OM": ["L2"], "Corte de Balloon": ["H5"], "Proximal": ["L4"], "Distal Prep": ["L4","M4"], "Distal Laser": ["L3"], "Notch": ["L5"], "Hipotubo": ["M4"], "Sidearm": ["L2"], "Leak Test": ["L2"], "Plasma": ["H2"], "Hidro": ["H2"], "Fold": ["M1"], "Press": ["L2"], "Fundas": ["M1"], "Coil": ["M2"], "Pouch": ["L3"], "Empaque": ["M4"], "Bayoneta": ["M4"], "Marcadores": ["H5"], "Laser de M.": ["M4"], "OM Necking": ["L2"], "Midlap": ["L4"], "Corte": ["H5"], "Distal P": ["L4"], "Distal L.": ["L3"], "Punta": ["M5"], "LKS": ["L2"] };
const letraToClase = { H: "alta", M: "media", L: "baja" };

/* ========== VARIABLES DE ESTADO ========== */
let activePersonas = {}, activeEstaciones = {}, nameIndex = {}, activeOrdenEstaciones = [];
let ultimaRotacion = {}; // Lo que se ve en pantalla
let ultimaRotacionPrev = null; // Usado para comparar en la vista de medio día
let historialErgonomico = {};
let esVistaMedioDia = false;

/**
 * @type {object} rotacionMatutinaGuardada
 * Almacena el estado de la rotación matutina, incluyendo ediciones manuales.
 * Es la fuente de verdad a la que "Volver a Rotación" restaura.
 */
let rotacionMatutinaGuardada = {};
let lastReportDataUrl = null;


/* ========== NORMALIZACIÓN Y UTILIDADES ========== */
const NFD = /[\u0300-\u036f]/g;
function norm(s){ return (s||"").toString().normalize("NFD").replace(NFD,"").toLowerCase().replace(/\s+/g," ").trim(); }
function canonicalize(name){ return nameIndex[norm(name)]||null; }
function obtenerAusentes(){ return (document.getElementById("ausentesInput").value.split(/\r?\n/) || []).map(canonicalize).filter(Boolean); }

/* ========== GESTIÓN DE ESTADO (LOCALSTORAGE) ========== */
function getStorageKey(base) { const [familia, linea] = document.getElementById('context-selector').value.split('_'); return `${familia}-${linea}-${base}`; }
function guardarRotacion(rot, key){ localStorage.setItem(key, JSON.stringify(rot)); }
function cargarRotacion(key){ try { return JSON.parse(localStorage.getItem(key)); } catch(e) { return null; } }
function guardarHistorial(hist){ localStorage.setItem(getStorageKey('history'), JSON.stringify(hist)); }
function cargarHistorial(){ try { return JSON.parse(localStorage.getItem(getStorageKey('history'))); } catch(e) { return null; } }

/* ========== ALGORITMO DE ROTACIÓN ========== */
function esCargaAlta(est) { return (ergoMap[est] || []).some(tag => tag.startsWith('H')); }
function candidatosPara(est, ausentesSet, asignadosSet){ return Object.keys(activePersonas).filter(p => activePersonas[p].includes(est) && !ausentesSet.has(p) && !asignadosSet.has(p)); }
function rellenarEstacionesVacias(rotacion) { const ausentes = new Set(obtenerAusentes()); const usadas = new Set(Object.values(rotacion).flat().filter(Boolean)); let sobrantes = Object.keys(activePersonas).filter(p => !usadas.has(p) && !ausentes.has(p)); for (const est of activeOrdenEstaciones) { const capacidad = activeEstaciones[est] || 0; const asignados = rotacion[est] ? [...rotacion[est]] : []; while (asignados.length < capacidad) { const candIndex = sobrantes.findIndex(p => activePersonas[p].includes(est)); if (candIndex === -1) break; const [p] = sobrantes.splice(candIndex,1); asignados.push(p); } rotacion[est] = asignados; } return rotacion; }
function intentarConstruirRotacion(estacionesOrdenadas, ausentesSet) { const rot = {}; const asignados = new Set(); for (const est of Object.keys(activeEstaciones)) rot[est] = []; for (const est of estacionesOrdenadas) { const needed = activeEstaciones[est] || 0; let cand = candidatosPara(est, ausentesSet, asignados); if (esCargaAlta(est)) { cand = cand.filter(p => { const h = historialErgonomico[p] || []; return !(h.length >= 2 && esCargaAlta(h[0]) && esCargaAlta(h[1])); }); } cand.sort((a,b) => (activePersonas[a].length - activePersonas[b].length)); if (cand.length === 0) continue; const seleccion = cand.slice(0, Math.min(needed, cand.length)); rot[est] = [...seleccion]; seleccion.forEach(p => asignados.add(p)); } return rot; }
function evaluarRotacion(rotacion) { const estacionesLlenas = Object.keys(rotacion).filter(e => (rotacion[e]||[]).length >= (activeEstaciones[e]||0)).length; const usadas = new Set(Object.values(rotacion).flat().filter(Boolean).map(p=>p.replace(/ \(T\)$/,''))); const sobrantes = Object.keys(activePersonas).filter(p => !usadas.has(p) && !new Set(obtenerAusentes()).has(p)).length; const assignedAll = Object.values(rotacion).flat().map(p=>p.replace(/ \(T\)$/,'')); const duplicates = assignedAll.length - new Set(assignedAll).size; return estacionesLlenas * 100 - sobrantes * 10 - duplicates * 50; }
function generarRotacionOptimizada(intentos = 60) { const ausentesSet = new Set(obtenerAusentes()); let mejor = null; let mejorScore = -Infinity; const baseOrden = [...activeOrdenEstaciones].sort((a,b) => (candidatosPara(a, ausentesSet, new Set()).length - candidatosPara(b, ausentesSet, new Set()).length) || ((esCargaAlta(b)?1:0) - (esCargaAlta(a)?1:0))); for (let i=0;i<intentos;i++) { const estacionesOrdenadas = [...baseOrden]; if (i % 3 === 0) estacionesOrdenadas.reverse(); if (i % 5 === 0) estacionesOrdenadas.sort(() => Math.random() - 0.5); const rot = intentarConstruirRotacion(estacionesOrdenadas, ausentesSet); const rotRellenada = rellenarEstacionesVacias(JSON.parse(JSON.stringify(rot))); const score = evaluarRotacion(rotRellenada); if (score > mejorScore) { mejorScore = score; mejor = rotRellenada; } } return { rotacion: mejor || rellenarEstacionesVacias(intentarConstruirRotacion(baseOrden, new Set())) }; }

/* ========== CONTROLADORES DE BOTONES ========== */
function actualizarHistorial(rotacionGenerada) { for (const est in rotacionGenerada) { for (const personaRaw of rotacionGenerada[est]) { const persona = personaRaw.replace(/ \(T\)$/,''); if (!historialErgonomico[persona]) historialErgonomico[persona] = []; historialErgonomico[persona].unshift(est); historialErgonomico[persona] = historialErgonomico[persona].slice(0, 2); } } }

function generarRotacion(){
    esVistaMedioDia = false;
    const { rotacion: nuevaRotacion } = generarRotacionOptimizada(60);
    ultimaRotacion = nuevaRotacion;
    // Esta es ahora la fuente de verdad para la rotación matutina.
    rotacionMatutinaGuardada = JSON.parse(JSON.stringify(nuevaRotacion));
    ultimaRotacionPrev = null;
    actualizarHistorial(ultimaRotacion);
    guardarRotacion(ultimaRotacion, getStorageKey("last"));
    guardarHistorial(historialErgonomico);
    actualizarTabla();
}

/**
 * Restaura la rotación matutina guardada, incluyendo cualquier edición manual.
 */
function volverARotacion() {
    if (!rotacionMatutinaGuardada || Object.keys(rotacionMatutinaGuardada).length === 0) {
        alert("No hay una rotación base para restaurar. Genere una rotación primero.");
        return;
    }
    // Restaura la vista a partir del estado guardado.
    ultimaRotacion = JSON.parse(JSON.stringify(rotacionMatutinaGuardada));
    esVistaMedioDia = false;
    ultimaRotacionPrev = null;
    guardarRotacion(ultimaRotacion, getStorageKey("last"));
    actualizarTabla();
    alert("Se ha vuelto a la rotación matutina.");
}

function generarMedioDia(){
    if (Object.keys(rotacionMatutinaGuardada).length === 0) {
        alert("Primero genera una rotación inicial con el botón 'Rotación'.");
        return;
    }
    esVistaMedioDia = true;
    ultimaRotacionPrev = JSON.parse(JSON.stringify(rotacionMatutinaGuardada));
    let mejorRotacion = null;
    let mejorPuntaje = -Infinity;
    for (let i = 0; i < 30; i++) {
        const { rotacion: intento } = generarRotacionOptimizada(20);
        let personasRotadas = 0;
        for (const est in intento) {
            const list = (intento[est]||[]).map(x=>x.replace(/ \(T\)$/,''));
            const prev = (ultimaRotacionPrev[est]||[]).map(x=>x.replace(/ \(T\)$/,''));
            for (const p of list) if (!prev.includes(p)) personasRotadas++;
        }
        if (personasRotadas > mejorPuntaje) {
            mejorPuntaje = personasRotadas;
            mejorRotacion = intento;
        }
    }
    ultimaRotacion = mejorRotacion || generarRotacionOptimizada(10).rotacion;
    actualizarHistorial(ultimaRotacion);
    guardarRotacion(ultimaRotacion, getStorageKey("last")); // Guarda el estado de medio día
    guardarHistorial(historialErgonomico);
    actualizarTabla();
}

/* ========== INTERFAZ DE USUARIO (UI) ========== */
function togglePresentationMode() { document.body.classList.toggle('presentation-mode'); }
function tagsForStation(est){ return (ergoMap[est]||[]).map(t => ({letra:t[0], clase:letraToClase[t[0]]||"otro"})); }
function claseDominante(tags){ let b={s:0,c:"baja"}; for(const t of tags){const s=({H:3,M:2,L:1})[t.letra]||0; if(s>b.s) b={s,c:t.clase};} return b.c; }
function bodyPart(n){ return ({1:"Cuello",2:"Hombros",3:"Codos",4:"Muñecas",5:"Manos"})[n]||""; }
function loadName(l){ return ({H:"Alta", M:"Media", L:"Baja"})[l]||""; }
function getErgoTooltipText(station) { const tags = ergoMap[station] || []; if (!tags.length) return ""; return `Carga Ergonómica: ${tags.map(t => `${loadName(t[0])} (${bodyPart(parseInt(t.slice(1),10))})`).join('; ')}`; }

function actualizarContadores() { const totalPersonal = Object.keys(activePersonas).length; const numAusentes = obtenerAusentes().length; const presentes = totalPersonal - numAusentes; const contadorDiv = document.getElementById('contador-personal'); let ausentesHtml = numAusentes > 0 ? ` <span style="color:red;">(-${numAusentes} Ausentes)</span>` : ''; let porcentajeHtml = ''; if (esVistaMedioDia && presentes > 0) { let numNoRotando = 0; if (ultimaRotacion && ultimaRotacionPrev) { for (const est in ultimaRotacion) { if (ultimaRotacion[est] && ultimaRotacionPrev[est]) { for (const p of ultimaRotacion[est]) { if (ultimaRotacionPrev[est].includes(p.replace(/ \(T\)$/,''))) numNoRotando++; } } } } const numSobrantes = document.querySelectorAll('#sobrantes tbody tr').length; const totalNoRotando = numNoRotando + numSobrantes; const numRotando = presentes - totalNoRotando; const porcentaje = presentes > 0 ? (numRotando / presentes) * 100 : 0; const color = porcentaje < 80 ? 'red' : 'green'; porcentajeHtml = ` <span style="margin-left: 15px; color: ${color};">(${porcentaje.toFixed(0)}%)</span>`; const diaSemana = new Date().getDay(); if(diaSemana >= 1 && diaSemana <= 5) { const dias = ['L', 'M', 'K', 'J', 'V']; const idDia = dias[diaSemana - 1]; const pctSpan = document.getElementById(`pct-${idDia}`); if(pctSpan) { pctSpan.textContent = `${porcentaje.toFixed(0)}%`; actualizarEstilosSemana(); guardarDatosSemana(); } } } if (contadorDiv) contadorDiv.innerHTML = `${presentes}/${totalPersonal} TM Presentes` + ausentesHtml + porcentajeHtml; }

const getDuplicateAssignments = () => { const assignments = new Map(); const duplicates = new Set(); for (const station in ultimaRotacion) { for (const person of ultimaRotacion[station]) { const p = person.replace(/ \(T\)$/,''); if (assignments.has(p)) duplicates.add(p); else assignments.set(p, station); } } return duplicates; };

function actualizarCeldaEditada(event) {
    const td = event.target;
    const est = td.dataset.station;
    const nombres = td.textContent.split('-').map(s => s.trim()).filter(Boolean);
    const personasFinal = [];
    for (const nombre of nombres) {
        const pCanonica = canonicalize(nombre);
        const esEntrenamiento = pCanonica && !activePersonas[pCanonica].includes(est);
        if (pCanonica) personasFinal.push(esEntrenamiento ? `${pCanonica} (T)` : pCanonica);
        else personasFinal.push(nombre);
    }
    if (activeEstaciones[est]) ultimaRotacion[est] = personasFinal.filter(p => canonicalize(p.replace(/ \(T\)$/,'')));

    // Si no estamos en vista de medio día, cualquier cambio manual actualiza el estado guardado.
    if (!esVistaMedioDia) {
        rotacionMatutinaGuardada = JSON.parse(JSON.stringify(ultimaRotacion));
    }

    const capacity = activeEstaciones[est] || 0;
    const duplicates = getDuplicateAssignments();
    const personasHtml = nombres.map((nombre, index) => {
        const pCanonica = canonicalize(nombre);
        if (!pCanonica) return `<span style="color:red;font-weight:bold;">${nombre}</span>`;
        const pFinal = personasFinal.find(p => canonicalize(p.replace(/ \(T\)$/,'')) === pCanonica);
        if (esVistaMedioDia && ultimaRotacionPrev && ultimaRotacionPrev[est]?.includes(pCanonica)) return `<span style="color:red;font-weight:bold;">${pFinal}</span>`;
        if (duplicates.has(pCanonica)) return `<span style="color:darkred;font-weight:bold;">${pFinal}</span>`;
        if (index >= capacity) return `<span style="color:orange;font-weight:bold;">${pFinal}</span>`;
        return pFinal;
    }).join(' - ');
    td.innerHTML = (nombres.length === 0) ? `<span>(sin asignar)</span>` : personasHtml;
    td.parentElement.classList.toggle('unassigned', nombres.length === 0);
    guardarRotacion(ultimaRotacion, getStorageKey("last"));
    actualizarSobrantes();
    actualizarContadores();
}

function actualizarTabla(){
    const tbody=document.querySelector("#rotacion tbody");
    tbody.innerHTML="";
    if (!activeOrdenEstaciones) return;
    const duplicates = getDuplicateAssignments();
    for(const est of activeOrdenEstaciones) {
        const pers = ultimaRotacion[est] || [];
        const tr=document.createElement("tr");
        const tags = tagsForStation(est);
        const tdEst=document.createElement("td");
        tdEst.textContent = est;
        tdEst.className = "station-name";
        if(tags.length){ tdEst.classList.add(claseDominante(tags)); tdEst.title = getErgoTooltipText(est); }
        const tdPers=document.createElement("td");
        tdPers.contentEditable="true";
        tdPers.dataset.station = est;
        if (pers.length === 0) { tdPers.innerHTML = `<span>(sin asignar)</span>`; tr.classList.add("unassigned"); }
        else { const capacity = activeEstaciones[est] || 0; tdPers.innerHTML = pers.map((p, index) => { const pCanon = p.replace(/ \(T\)$/,''); if (esVistaMedioDia && ultimaRotacionPrev && ultimaRotacionPrev[est]?.includes(pCanon)) return `<span style="color:red;font-weight:bold;">${p}</span>`; if (duplicates.has(pCanon)) return `<span style="color:darkred;font-weight:bold;">${p}</span>`; if (index >= capacity) return `<span style="color:orange;font-weight:bold;">${p}</span>`; return p; }).join(' - '); }
        tdPers.addEventListener("blur", actualizarCeldaEditada);
        tr.append(tdEst, tdPers);
        tbody.appendChild(tr);
    }
    actualizarSobrantes();
    actualizarContadores();
}

function actualizarSobrantes(){
    const usadas = new Set(Object.values(ultimaRotacion).flat().map(p => canonicalize(p.replace(/ \(T\)$/, ''))).filter(Boolean));
    const ausentes=new Set(obtenerAusentes());
    const sobrantes=Object.keys(activePersonas).filter(p=>!usadas.has(p)&&!ausentes.has(p));
    const tbodyS=document.querySelector("#sobrantes tbody");
    tbodyS.innerHTML = sobrantes.map(p=>`<tr><td>${p}</td></tr>`).join('');
}

async function descargarImagen() {
    document.body.classList.add('presentation-mode');
    await new Promise(r => setTimeout(r, 100));
    const mainContainer = document.querySelector('.page-wrapper');
    const canvas = await html2canvas(mainContainer, { scale: 2 });
    const imgUrl = canvas.toDataURL("image/png");
    const printWindow = window.open('', '_blank');
    printWindow.document.write(`<img src="${imgUrl}" style="width:100%;">`);
    printWindow.document.close();
    printWindow.focus();
    document.body.classList.remove('presentation-mode');
}

async function copiarLista(){
    let t="";
    document.querySelectorAll("#rotacion tbody tr").forEach(r => {
        t+=`${r.cells[0].textContent}: ${r.cells[1].textContent}\n`;
    });
    await navigator.clipboard.writeText(t);
    alert("Rotación copiada.");
}

const dias = ['L', 'M', 'K', 'J', 'V'];
function actualizarEstilosSemana() {
    dias.forEach(dia => {
        const span = document.getElementById(`pct-${dia}`);
        if(!span) return;
        const valor = parseInt(span.textContent.replace('%',''),10);
        span.style.color = !isNaN(valor) && valor < 80 ? 'red' : 'green';
    });
}
function guardarDatosSemana() {
    const datos = {};
    dias.forEach(dia => {
        datos[dia] = document.getElementById(`pct-${dia}`).textContent;
    });
    localStorage.setItem(getStorageKey('semanaPct'), JSON.stringify(datos));
}
function cargarDatosSemana() {
    const datos = JSON.parse(localStorage.getItem(getStorageKey('semanaPct')) || '{}');
    dias.forEach(dia => {
        document.getElementById(`pct-${dia}`).textContent = datos[dia] || '0%';
    });
    actualizarEstilosSemana();
}

/* ========== MODOS Y BASE DE DATOS ========== */
function togglePresentationMode(){ document.body.classList.toggle('presentation-mode'); }

// --- FUNCIONES PARA REPORTE SEMANAL ---
function getPresentesYNoRotantes(){
    const totalPersonal = Object.keys(activePersonas).length;
    const ausentes = new Set(obtenerAusentes());
    const presentes = totalPersonal - ausentes.size;
    const usadas = new Set(Object.values(ultimaRotacion||{}).flat().map(p => canonicalize(p.replace(/ \(T\)$/,''))).filter(Boolean));
    const noRotantes = Object.keys(activePersonas).filter(p => !usadas.has(p) && !ausentes.has(p)).length;
    return { presentes, noRotantes };
}
function formatDate(d){ return `${d.getDate().toString().padStart(2,'0')}/${(d.getMonth()+1).toString().padStart(2,'0')}/${d.getFullYear()}`; }
function weekRangeDates(){
    const t=new Date(),d=t.getDay(),m=new Date(t);
    m.setDate(t.getDate()-((d+6)%7));
    const f=new Date(m); f.setDate(m.getDate()+4);
    return {m,f};
}

async function generarReporteSemanal(){
    const pct={}; dias.forEach(d=>{const e=document.getElementById(`pct-${d}`); pct[d]=(e?e.textContent.trim():'0%');});
    const {presentes,noRotantes}=getPresentesYNoRotantes(); const{m,f}=weekRangeDates();
    const yo={
        mejoro:document.getElementById('yo-mejoro').textContent.trim(),
        reconozco:document.getElementById('yo-reconozco').textContent.trim(),
        anticipo:document.getElementById('yo-anticipo').textContent.trim(),
        cumplo:document.getElementById('yo-cumplo').textContent.trim(),
        respeto:document.getElementById('yo-respeto').textContent.trim()
    };
    const reportDiv=document.createElement('div');
    reportDiv.style.cssText="width:1000px; padding:24px; background:white; font-family:Open Sans,sans-serif; color:#222; position:fixed; left:-20000px;";
    const makeYoRow=(l,t,c)=>`<div style="display:flex;gap:8px;align-items:flex-start;"><div style="min-width:130px;font-weight:700">${l}</div><div style="flex:1;padding:8px;border-radius:6px;background:${c};min-height:34px">${t||'-'}</div></div>`;
    reportDiv.innerHTML=
        `<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px;">
            <div style="font-size:20px;font-weight:800;color:var(--primary-color)">Reporte Semanal - Rotación</div>
            <div style="font-size:14px;color:#555">Semana: ${formatDate(m)} - ${formatDate(f)}</div>
        </div>
        <div style="display:flex;gap:12px;margin-bottom:12px;">
            <div style="font-weight:700">TM Presentes: ${presentes}</div>
            <div style="font-weight:700">No rotantes: ${noRotantes}</div>
        </div>
        <table style="width:100%;border-collapse:collapse;">
            <thead><tr><th style="text-align:left;padding:8px;border-bottom:1px solid #eee">Día</th><th style="text-align:left;padding:8px;border-bottom:1px solid #eee">Porcentaje</th></tr></thead>
            <tbody>${Object.entries(pct).map(([d,v])=>`<tr><td style="padding:8px;border-bottom:1px solid #f2f2f2;font-weight:700">${d}</td><td style="padding:8px;border-bottom:1px solid #f2f2f2;color:${(parseInt(v,10)>=80?'green':'red')};font-weight:800">${v}</td></tr>`).join('')}</tbody>
        </table>
        <div style="margin-top:14px;font-weight:800">Acciones/Observaciones (Yo...)</div>
        <div style="display:grid;grid-template-columns:1fr;gap:8px;margin-top:8px;">
            ${makeYoRow('Yo Mejoro',yo.mejoro,'var(--yo-mejoro)')}
            ${makeYoRow('Yo Reconozco',yo.reconozco,'var(--yo-reconozco)')}
            ${makeYoRow('Yo Anticipo',yo.anticipo,'var(--yo-anticipo)')}
            ${makeYoRow('Yo Cumplo',yo.cumplo,'var(--yo-cumplo)')}
            ${makeYoRow('Yo Respeto',yo.respeto,'var(--yo-respeto)')}
        </div>`;
    document.body.appendChild(reportDiv);
    try {
        const canvas=await html2canvas(reportDiv,{scale:2,useCORS:true});
        lastReportDataUrl=canvas.toDataURL('image/png');
        showReportModal(lastReportDataUrl);
    } catch(err){
        alert('Error al generar reporte: '+(err.message||err));
    } finally {
        reportDiv.remove();
    }
}
function showReportModal(dataUrl){
    document.getElementById('report-modal-image-container').innerHTML=`<img src="${dataUrl}" alt="Reporte Semanal">`;
    document.getElementById('report-modal').style.display='block';
}
function closeReportModal(evt){
    if(!evt || evt.target.id==='report-modal') document.getElementById('report-modal').style.display='none';
}
function downloadCurrentReport(){
    if(!lastReportDataUrl)return;
    const a=document.createElement('a');
    const {m,f}=weekRangeDates();
    a.href=lastReportDataUrl;
    a.download=`Reporte_Semanal_${formatDate(m)}_${formatDate(f)}.png`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
}

/* ========== CAMBIO DE CONTEXTO ========== */
function switchContext() {
    const [familia, linea] = document.getElementById('context-selector').value.split('_');
    const contextData = database[familia]?.[linea];
    if (!contextData) { alert("Contexto no válido."); return; }
    activePersonas = contextData.personas;
    activeEstaciones = contextData.estaciones;
    activeOrdenEstaciones = contextData.ordenEstaciones || Object.keys(activeEstaciones);
    nameIndex = Object.keys(activePersonas).reduce((acc,p)=>{acc[norm(p)]=p;return acc;},{});    
    esVistaMedioDia = false;
    ultimaRotacion = cargarRotacion(getStorageKey("last")) || {};
    // Al cambiar de contexto, la rotación cargada se convierte en la nueva base guardada.
    rotacionMatutinaGuardada = JSON.parse(JSON.stringify(ultimaRotacion));
    ultimaRotacionPrev = null;
    historialErgonomico = cargarHistorial() || {};
    document.getElementById('ausentesInput').value = '';
    document.getElementById('comentarios').innerHTML = '';
    if (!Object.keys(ultimaRotacion).length) {
        for(const est of activeOrdenEstaciones) ultimaRotacion[est] = [];
    }
    cargarDatosSemana();
    actualizarTabla();
}

/* ========== LÓGICA DEL EDITOR DE BASE DE DATOS (FUERA DE switchContext) ========== */
let selectedPersonForEditing = null;
function getCurrentContext() {
    const [familia, linea] = document.getElementById('context-selector').value.split('_');
    return { familia, linea, data: database[familia]?.[linea] };
}
function openDbEditor() {
    document.getElementById('db-editor-modal').style.display = 'block';
    const { familia, linea, data } = getCurrentContext();
    if (!data) { alert("Contexto no válido."); return; }
    document.getElementById('editor-context-title').textContent = `${familia} - ${linea}`;
    const personList = document.getElementById('person-list');
    personList.innerHTML = '';
    const personNames = Object.keys(data.personas).sort();
    personNames.forEach(name => {
        const li = document.createElement('li');
        li.textContent = name;
        li.onclick = () => selectPersonForEditing(name);
        personList.appendChild(li);
    });
    if (personNames.length > 0) {
        selectPersonForEditing(personNames[0]);
    } else {
        document.getElementById('person-name-input').value = '';
        document.getElementById('station-checkboxes').innerHTML = '';
    }
}
function closeDbEditor() { document.getElementById('db-editor-modal').style.display = 'none'; }
function selectPersonForEditing(name) {
    selectedPersonForEditing = name;
    document.querySelectorAll('#person-list li').forEach(li => {
        li.classList.toggle('selected', li.textContent === name);
    });
    const { data } = getCurrentContext();
    const personSkills = data.personas[name] || [];
    document.getElementById('person-name-input').value = name;
    const stationCheckboxes = document.getElementById('station-checkboxes');
    stationCheckboxes.innerHTML = '';
    const allStations = Object.keys(data.estaciones).sort();
    allStations.forEach(station => {
        const isChecked = personSkills.includes(station);
        const label = document.createElement('label');
        label.innerHTML = `<input type="checkbox" value="${station}" ${isChecked ? 'checked' : ''}> ${station}`;
        stationCheckboxes.appendChild(label);
    });
}
function addNewPerson() {
    const newName = prompt("Introduce el nombre de la nueva persona:");
    if (!newName || newName.trim() === "") return;
    const { data } = getCurrentContext();
    if (data.personas[newName]) { alert("Esta persona ya existe."); return; }
    data.personas[newName] = [];
    openDbEditor();
    selectPersonForEditing(newName);
}
function deleteSelectedPerson() {
    if (!selectedPersonForEditing) { alert("Por favor, selecciona una persona para eliminar."); return; }
    if (confirm(`¿Estás seguro de que quieres eliminar a ${selectedPersonForEditing}?`)) {
        const { data } = getCurrentContext();
        delete data.personas[selectedPersonForEditing];
        selectedPersonForEditing = null;
        openDbEditor();
    }
}
function saveDbChanges() {
    const { data } = getCurrentContext();
    const currentName = selectedPersonForEditing;
    const newName = document.getElementById('person-name-input').value.trim();
    if (!newName) { alert("El nombre no puede estar vacío."); return; }
    const newSkills = [];
    document.querySelectorAll('#station-checkboxes input:checked').forEach(checkbox => {
        newSkills.push(checkbox.value);
    });
    if (currentName !== newName) {
        if (data.personas[newName]) { alert("El nuevo nombre ya existe. Por favor, elige otro."); return; }
        delete data.personas[currentName];
        data.personas[newName] = newSkills;
    } else {
        data.personas[currentName] = newSkills;
    }
    localStorage.setItem('rotationDatabase', JSON.stringify(database));
    closeDbEditor();
    alert("¡Base de datos actualizada! El sistema se recargará con los nuevos datos.");
    switchContext();
}

/* ========== INICIALIZACIÓN ========== */
document.addEventListener("DOMContentLoaded",()=>{
    loadDatabase();
    document.getElementById('context-selector').addEventListener('change', switchContext);
    document.getElementById("ausentesInput").addEventListener("input", () => {
        actualizarSobrantes(); actualizarContadores();
    });
    dias.forEach(dia => {
        const span = document.getElementById(`pct-${dia}`);
        if(span) span.addEventListener('blur', () => {
            guardarDatosSemana(); actualizarEstilosSemana();
        });
    });
    switchContext();
});
</script>

<!-- ========== MODAL EDITOR DE BASE DE DATOS ========== -->
<div id="db-editor-modal" class="modal-overlay">
    <div class="modal-content">
        <h2>Editor de Base de Datos - <span id="editor-context-title"></span></h2>
        <div class="editor-grid">
            <div>
                <h3>Personal</h3>
                <ul id="person-list"></ul>
                <button onclick="addNewPerson()">Añadir Persona</button>
                <button onclick="deleteSelectedPerson()" style="background-color: #dc3545;">Eliminar</button>
            </div>
            <div>
                <h3>Detalles de la Persona</h3>
                <label for="person-name-input"><strong>Nombre:</strong></label>
                <input type="text" id="person-name-input" style="width: 95%; padding: 8px; margin-bottom: 15px; font-size: 1em;">
                <h4>Estaciones Asignadas</h4>
                <div id="station-checkboxes" class="station-checkboxes"></div>
            </div>
        </div>
        <hr>
        <button onclick="saveDbChanges()" class="db-editor-btn">Guardar Cambios y Recargar</button>
        <button onclick="closeDbEditor()" style="background-color: #6c757d;">Cancelar</button>
    </div>
</div>

</body>
</html>

